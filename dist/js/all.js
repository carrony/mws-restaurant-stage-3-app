"use strict";navigator.serviceWorker&&(navigator.serviceWorker.register("./sw.js",{scope:"./"}).then(function(e){console.log("sevice worker registered")}).catch(function(e){console.log("error registering...")}),navigator.serviceWorker.ready.then(function(e){return e.sync.register("sendPendingPost")}),window.addEventListener("online",function(){navigator.serviceWorker.controller.postMessage("online"),console.log("online")})),function(){function u(n){return new Promise(function(e,t){n.onsuccess=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function i(n,r,o){var i,e=new Promise(function(e,t){u(i=n[r].apply(n,o)).then(e,t)});return e.request=i,e}function e(e,n,t){t.forEach(function(t){Object.defineProperty(e.prototype,t,{get:function(){return this[n][t]},set:function(e){this[n][t]=e}})})}function t(t,n,r,e){e.forEach(function(e){e in r.prototype&&(t.prototype[e]=function(){return i(this[n],e,arguments)})})}function n(t,n,r,e){e.forEach(function(e){e in r.prototype&&(t.prototype[e]=function(){return this[n][e].apply(this[n],arguments)})})}function r(e,r,t,n){n.forEach(function(n){n in t.prototype&&(e.prototype[n]=function(){return e=this[r],(t=i(e,n,arguments)).then(function(e){if(e)return new a(e,t.request)});var e,t})})}function o(e){this._index=e}function a(e,t){this._cursor=e,this._request=t}function c(e){this._store=e}function s(n){this._tx=n,this.complete=new Promise(function(e,t){n.oncomplete=function(){e()},n.onerror=function(){t(n.error)},n.onabort=function(){t(n.error)}})}function l(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new s(n)}function f(e){this._db=e}e(o,"_index",["name","keyPath","multiEntry","unique"]),t(o,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),r(o,"_index",IDBIndex,["openCursor","openKeyCursor"]),e(a,"_cursor",["direction","key","primaryKey","value"]),t(a,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(n){n in IDBCursor.prototype&&(a.prototype[n]=function(){var t=this,e=arguments;return Promise.resolve().then(function(){return t._cursor[n].apply(t._cursor,e),u(t._request).then(function(e){if(e)return new a(e,t._request)})})})}),c.prototype.createIndex=function(){return new o(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new o(this._store.index.apply(this._store,arguments))},e(c,"_store",["name","keyPath","indexNames","autoIncrement"]),t(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),r(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),n(c,"_store",IDBObjectStore,["deleteIndex"]),s.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},e(s,"_tx",["objectStoreNames","mode"]),n(s,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},e(l,"_db",["name","version","objectStoreNames"]),n(l,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new s(this._db.transaction.apply(this._db,arguments))},e(f,"_db",["name","version","objectStoreNames"]),n(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(i){[c,o].forEach(function(e){i in e.prototype&&(e.prototype[i.replace("open","iterate")]=function(){var e,t=(e=arguments,Array.prototype.slice.call(e)),n=t[t.length-1],r=this._store||this._index,o=r[i].apply(r,t.slice(0,-1));o.onsuccess=function(){n(o.result)}})})}),[o,c].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,n){var r=this,o=[];return new Promise(function(t){r.iterateCursor(e,function(e){e?(o.push(e.value),void 0===n||o.length!=n?e.continue():t(o)):t(o)})})})});var h={open:function(e,t,n){var r=i(indexedDB,"open",[e,t]),o=r.request;return o&&(o.onupgradeneeded=function(e){n&&n(new l(o.result,e.oldVersion,o.transaction))}),r.then(function(e){return new f(e)})},delete:function(e){return i(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?(module.exports=h,module.exports.default=module.exports):self.idb=h}();var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function u(){_classCallCheck(this,u)}return _createClass(u,null,[{key:"fetchRestaurants",value:function(r){var t=idb.open("restauntsDB",1,function(e){e.createObjectStore("restaurants",{keyPath:"id"})});t.then(function(e){return e.transaction("restaurants").objectStore("restaurants").getAll()}).then(function(e){0==e.length?(console.log("no hay datos"),fetch(u.DATABASE_URL).then(function(e){return e.json()}).then(function(n){t.then(function(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");n.forEach(function(e){t.put(e)}),r(null,n)})}).catch(function(e){r(e,null)})):r(null,e)})}},{key:"fetchRestaurantById",value:function(r,o){u.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.find(function(e){return e.id==r});n?o(null,n):o("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(r,o){u.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.cuisine_type==r});o(null,n)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,o){u.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.neighborhood==r});o(null,n)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,o,i){u.fetchRestaurants(function(e,t){if(e)i(e,null);else{var n=t;"all"!=r&&(n=n.filter(function(e){return e.cuisine_type==r})),"all"!=o&&(n=n.filter(function(e){return e.neighborhood==o})),i(null,n)}})}},{key:"fetchNeighborhoods",value:function(o){u.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}})}},{key:"fetchCuisines",value:function(o){u.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imagesSrcsetForRestaurant",value:function(e){var t=e.photograph;return t||(t="10"),"/img/"+t+"-small.jpg 250w,\n            /img/"+t+"-medium.jpg 460w,\n            /img/"+t+"-large.jpg 800w"}},{key:"imageSizesForRestaurant",value:function(e){return e?"(max-width: 618px) calc(100vw - 80px), calc(50vw - 80px)":"(max-width: 618px) calc(100vw - 90px), calc(50vw - 90px)"}},{key:"imageUrlForRestaurant",value:function(e){var t=e.photograph;return t||(t="10"),"/img/"+t+"-small.jpg"}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:u.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"storeReviewsDB",value:function(n,e){return idb.open(e,1,function(e){e.createObjectStore("reviews",{keyPath:"name"})}).then(function(e){var t=e.transaction("reviews","readwrite").objectStore("reviews");n.forEach(function(e){t.put(e)})})}},{key:"removeReviewFromDB",value:function(t,n){return idb.open(n,1,function(e){e.createObjectStore("reviews",{keyPath:"name"})}).then(function(e){console.log(n),e.transaction("reviews","readwrite").objectStore("reviews").delete(t.name)})}},{key:"getAllReviewsDB",value:function(e){return idb.open(e,1,function(e){e.createObjectStore("reviews",{keyPath:"name"})}).then(function(e){return e.transaction("reviews").objectStore("reviews").getAll()})}},{key:"sendPostRequest",value:function(n){return fetch(u.REVIEWS_URL,{method:"POST",body:JSON.stringify(n)}).catch(function(e){var t=[];return t.push(n),console.log("database"),u.storeReviewsDB(t,"pendingPostsDB")})}},{key:"addToFavorites",value:function(e){var t=this;fetch(u.DATABASE_URL+"/"+e+"/?is_favorite=true",{method:"PUT"}).then(function(){console.log("updated"),t.updateRestaurant(e,"true")}).catch(function(e){return console.log(e)})}},{key:"removeFromFavorites",value:function(e){var t=this;fetch(u.DATABASE_URL+"/"+e+"/?is_favorite=false",{method:"PUT"}).then(function(){console.log("updated"),t.updateRestaurant(e,"false")}).catch(function(e){return console.log(e)})}},{key:"updateRestaurant",value:function(n,r){return idb.open("restauntsDB",1,function(e){e.createObjectStore("restaurants",{keyPath:"id"})}).then(function(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");t.get(n).then(function(e){e.is_favorite=r,t.put(e)})})}},{key:"deleteReview",value:function(e){if(e.id)return fetch((e.id,{method:"DELETE"}))}},{key:"fetchReviewsById",value:function(e,t){fetch(u.REVIEWS_URL+"?restaurant_id="+e).then(function(e){return e.json()}).then(function(e){u.storeReviewsDB(e,"reviews").then(t(null,e)).catch(function(e){return t(e,null)})}).catch(function(e){u.getAllReviewsDB("reviews").then(function(e){t(null,e)}).catch(function(e){t(e,null)})})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}},{key:"REVIEWS_URL",get:function(){return"http://localhost:1337/reviews/"}}]),u}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN3X3JlZ2lzdGVyLmpzIiwiaWRiLmpzIiwiZGJoZWxwZXIuanMiXSwibmFtZXMiOlsibmF2aWdhdG9yIiwic2VydmljZVdvcmtlciIsInJlZ2lzdGVyIiwic2NvcGUiLCJ0aGVuIiwicmVnIiwiY29uc29sZSIsImxvZyIsImNhdGNoIiwiZXJyIiwicmVhZHkiLCJzd1JlZ2lzdHJhdGlvbiIsInN5bmMiLCJ3aW5kb3ciLCJhZGRFdmVudExpc3RlbmVyIiwiY29udHJvbGxlciIsInBvc3RNZXNzYWdlIiwicHJvbWlzaWZ5UmVxdWVzdCIsInJlcXVlc3QiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uc3VjY2VzcyIsInJlc3VsdCIsIm9uZXJyb3IiLCJlcnJvciIsInByb21pc2lmeVJlcXVlc3RDYWxsIiwib2JqIiwibWV0aG9kIiwiYXJncyIsInAiLCJhcHBseSIsInByb3h5UHJvcGVydGllcyIsIlByb3h5Q2xhc3MiLCJ0YXJnZXRQcm9wIiwicHJvcGVydGllcyIsImZvckVhY2giLCJwcm9wIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJwcm90b3R5cGUiLCJnZXQiLCJ0aGlzIiwic2V0IiwidmFsIiwicHJveHlSZXF1ZXN0TWV0aG9kcyIsIkNvbnN0cnVjdG9yIiwiYXJndW1lbnRzIiwicHJveHlNZXRob2RzIiwicHJveHlDdXJzb3JSZXF1ZXN0TWV0aG9kcyIsInZhbHVlIiwiQ3Vyc29yIiwiSW5kZXgiLCJpbmRleCIsIl9pbmRleCIsImN1cnNvciIsIl9jdXJzb3IiLCJfcmVxdWVzdCIsIk9iamVjdFN0b3JlIiwic3RvcmUiLCJfc3RvcmUiLCJUcmFuc2FjdGlvbiIsImlkYlRyYW5zYWN0aW9uIiwiX3R4IiwiY29tcGxldGUiLCJvbmNvbXBsZXRlIiwib25hYm9ydCIsIlVwZ3JhZGVEQiIsImRiIiwib2xkVmVyc2lvbiIsInRyYW5zYWN0aW9uIiwiX2RiIiwiREIiLCJJREJJbmRleCIsIklEQkN1cnNvciIsIm1ldGhvZE5hbWUiLCJjcmVhdGVJbmRleCIsIklEQk9iamVjdFN0b3JlIiwib2JqZWN0U3RvcmUiLCJJREJUcmFuc2FjdGlvbiIsImNyZWF0ZU9iamVjdFN0b3JlIiwiSURCRGF0YWJhc2UiLCJmdW5jTmFtZSIsInJlcGxhY2UiLCJhcnIiLCJBcnJheSIsInNsaWNlIiwiY2FsbCIsImNhbGxiYWNrIiwibGVuZ3RoIiwibmF0aXZlT2JqZWN0IiwiZ2V0QWxsIiwicXVlcnkiLCJjb3VudCIsImluc3RhbmNlIiwiaXRlbXMiLCJpdGVyYXRlQ3Vyc29yIiwicHVzaCIsInVuZGVmaW5lZCIsImNvbnRpbnVlIiwiZXhwIiwib3BlbiIsIm5hbWUiLCJ2ZXJzaW9uIiwidXBncmFkZUNhbGxiYWNrIiwiaW5kZXhlZERCIiwib251cGdyYWRlbmVlZGVkIiwiZXZlbnQiLCJkZWxldGUiLCJtb2R1bGUiLCJleHBvcnRzIiwiZGVmYXVsdCIsInNlbGYiLCJpZGIiLCJEQkhlbHBlciIsImRiUHJvbWlzZSIsInVwZ3JhZGVEYiIsImtleVBhdGgiLCJyZXN0YXVyYW50cyIsImZldGNoIiwiREFUQUJBU0VfVVJMIiwicmVzcG9uc2UiLCJqc29uIiwicmVzdGF1cmFudFN0b3JlIiwiZWxlbWVudCIsInB1dCIsImlkIiwiZmV0Y2hSZXN0YXVyYW50cyIsInJlc3RhdXJhbnQiLCJmaW5kIiwiciIsImN1aXNpbmUiLCJyZXN1bHRzIiwiZmlsdGVyIiwiY3Vpc2luZV90eXBlIiwibmVpZ2hib3Job29kIiwibmVpZ2hib3Job29kcyIsIm1hcCIsInYiLCJpIiwidW5pcXVlTmVpZ2hib3Job29kcyIsImluZGV4T2YiLCJjdWlzaW5lcyIsInVuaXF1ZUN1aXNpbmVzIiwiZmlsZW5hbWUiLCJwaG90b2dyYXBoIiwiaW5uZXIiLCJnb29nbGUiLCJtYXBzIiwiTWFya2VyIiwicG9zaXRpb24iLCJsYXRsbmciLCJ0aXRsZSIsInVybCIsInVybEZvclJlc3RhdXJhbnQiLCJhbmltYXRpb24iLCJBbmltYXRpb24iLCJEUk9QIiwicmV2aWV3cyIsImRhdGFiYXNlIiwicmV2aWV3c1N0b3JlIiwicmV2aWV3IiwiUkVWSUVXU19VUkwiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInN0b3JlUmV2aWV3c0RCIiwiX3RoaXMiLCJ1cGRhdGVSZXN0YXVyYW50IiwiX3RoaXMyIiwiaXNfZmF2b3JpdGUiLCJnZXRBbGxSZXZpZXdzREIiXSwibWFwcGluZ3MiOiJhQUNJQSxVQUFVQyxnQkFFVkQsVUFBVUMsY0FBY0MsU0FBUyxVQUFVLENBQ3ZDQyxNQUFPLE9BQ1JDLEtBQUssU0FBU0MsR0FDYkMsUUFBUUMsSUFBSSw4QkFDYkMsTUFBTSxTQUFTQyxHQUNkSCxRQUFRQyxJQUFJLDBCQUdoQlAsVUFBVUMsY0FBY1MsTUFBTU4sS0FBSyxTQUFTTyxHQUN4QyxPQUFPQSxFQUFlQyxLQUFLVixTQUFTLHFCQUd4Q1csT0FBT0MsaUJBQWlCLFNBQVUsV0FDOUJkLFVBQVVDLGNBQWNjLFdBQVdDLFlBQVksVUFDL0NWLFFBQVFDLElBQUksYUNmbkIsV0FLQyxTQUFTVSxFQUFpQkMsR0FDeEIsT0FBTyxJQUFJQyxRQUFRLFNBQVNDLEVBQVNDLEdBQ25DSCxFQUFRSSxVQUFZLFdBQ2xCRixFQUFRRixFQUFRSyxTQUdsQkwsRUFBUU0sUUFBVSxXQUNoQkgsRUFBT0gsRUFBUU8sVUFLckIsU0FBU0MsRUFBcUJDLEVBQUtDLEVBQVFDLEdBQ3pDLElBQUlYLEVBQ0FZLEVBQUksSUFBSVgsUUFBUSxTQUFTQyxFQUFTQyxHQUVwQ0osRUFEQUMsRUFBVVMsRUFBSUMsR0FBUUcsTUFBTUosRUFBS0UsSUFDUHpCLEtBQUtnQixFQUFTQyxLQUkxQyxPQURBUyxFQUFFWixRQUFVQSxFQUNMWSxFQVdULFNBQVNFLEVBQWdCQyxFQUFZQyxFQUFZQyxHQUMvQ0EsRUFBV0MsUUFBUSxTQUFTQyxHQUMxQkMsT0FBT0MsZUFBZU4sRUFBV08sVUFBV0gsRUFBTSxDQUNoREksSUFBSyxXQUNILE9BQU9DLEtBQUtSLEdBQVlHLElBRTFCTSxJQUFLLFNBQVNDLEdBQ1pGLEtBQUtSLEdBQVlHLEdBQVFPLE9BTWpDLFNB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SixHQUVkNUMsRUFBU29ELGVBQWVSLEVBQVMsV0FDaEMxSixLQUFLb0YsRUFBUyxLQUFLc0UsSUFDbkJ0SixNQUFNLFNBQUFpQixHQUFBLE9BQVMrRCxFQUFTL0QsRUFBTSxVQUVoQ2pCLE1BQU0sU0FBVWlCLEdBR2Z5RixFQUFTeUQsZ0JBQWdCLFdBQ3hCdkssS0FBTSxTQUFVMEosR0FFZnRFLEVBQVMsS0FBS3NFLEtBQ2J0SixNQUFNLFNBQVNpQixHQUVoQitELEVBQVMvRCxFQUFNLCtDQXBYckIsTUFBQSx3RUFTQSxNQUFBIiwiZmlsZSI6ImFsbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vZm9yIGNvbXBhdGlibGUgYnJvd3NlcnNcclxuaWYgKG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7XHJcbiAgICAvLyBSRWdpc3RlcmluZyB0aGUgc2VydmljZSB3b3JrZXJcclxuICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKCcuL3N3LmpzJyx7XHJcbiAgICAgICAgc2NvcGU6ICcuLydcclxuICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVnKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ3NldmljZSB3b3JrZXIgcmVnaXN0ZXJlZCcpXHJcbiAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgcmVnaXN0ZXJpbmcuLi4nKTtcclxuICAgIH0pO1xyXG5cclxuICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlYWR5LnRoZW4oZnVuY3Rpb24oc3dSZWdpc3RyYXRpb24pIHtcclxuICAgICAgICByZXR1cm4gc3dSZWdpc3RyYXRpb24uc3luYy5yZWdpc3Rlcignc2VuZFBlbmRpbmdQb3N0Jyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlci5wb3N0TWVzc2FnZSgnb25saW5lJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJvbmxpbmVcIik7XHJcbiAgICB9KVxyXG5cclxuICAgIC8qbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYE1lbnNhamU6ICR7ZXZlbnRhLmRhdGF9YCk7XHJcbiAgICB9KSovXHJcblxyXG4gICAvKiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBzdGF0dXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInN0YXR1c1wiKTtcclxuICAgICAgICB2YXIgbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJsb2dcIik7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU9ubGluZVN0YXR1cyhldmVudCkge1xyXG4gICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IG5hdmlnYXRvci5vbkxpbmUgPyBcIm9ubGluZVwiIDogXCJvZmZsaW5lXCI7XHJcblxyXG4gICAgICAgICAgc3RhdHVzLmNsYXNzTmFtZSA9IGNvbmRpdGlvbjtcclxuICAgICAgICAgIHN0YXR1cy5pbm5lckhUTUwgPSBjb25kaXRpb24udG9VcHBlckNhc2UoKTtcclxuXHJcbiAgICAgICAgICBsb2cuaW5zZXJ0QWRqYWNlbnRIVE1MKFwiYmVmb3JlZW5kXCIsIFwiRXZlbnQ6IFwiICsgZXZlbnQudHlwZSArIFwiOyBTdGF0dXM6IFwiICsgY29uZGl0aW9uKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvbmxpbmUnLCAgdXBkYXRlT25saW5lU3RhdHVzKTtcclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb2ZmbGluZScsIHVwZGF0ZU9ubGluZVN0YXR1cyk7XHJcbiAgICAgIH0pOyovXHJcbn1cclxuXHJcblxyXG5cclxuIiwiJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIHRvQXJyYXkoYXJyKSB7XG4gICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFycik7XG4gIH1cblxuICBmdW5jdGlvbiBwcm9taXNpZnlSZXF1ZXN0KHJlcXVlc3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTtcbiAgICAgIH07XG5cbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvbWlzaWZ5UmVxdWVzdENhbGwob2JqLCBtZXRob2QsIGFyZ3MpIHtcbiAgICB2YXIgcmVxdWVzdDtcbiAgICB2YXIgcCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgcmVxdWVzdCA9IG9ialttZXRob2RdLmFwcGx5KG9iaiwgYXJncyk7XG4gICAgICBwcm9taXNpZnlSZXF1ZXN0KHJlcXVlc3QpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICB9KTtcblxuICAgIHAucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBmdW5jdGlvbiBwcm9taXNpZnlDdXJzb3JSZXF1ZXN0Q2FsbChvYmosIG1ldGhvZCwgYXJncykge1xuICAgIHZhciBwID0gcHJvbWlzaWZ5UmVxdWVzdENhbGwob2JqLCBtZXRob2QsIGFyZ3MpO1xuICAgIHJldHVybiBwLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICAgIHJldHVybiBuZXcgQ3Vyc29yKHZhbHVlLCBwLnJlcXVlc3QpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJveHlQcm9wZXJ0aWVzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIHByb3BlcnRpZXMpIHtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFByb3h5Q2xhc3MucHJvdG90eXBlLCBwcm9wLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXNbdGFyZ2V0UHJvcF1bcHJvcF07XG4gICAgICAgIH0sXG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgdGhpc1t0YXJnZXRQcm9wXVtwcm9wXSA9IHZhbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwcm94eVJlcXVlc3RNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHByb21pc2lmeVJlcXVlc3RDYWxsKHRoaXNbdGFyZ2V0UHJvcF0sIHByb3AsIGFyZ3VtZW50cyk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJveHlNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXNbdGFyZ2V0UHJvcF1bcHJvcF0uYXBwbHkodGhpc1t0YXJnZXRQcm9wXSwgYXJndW1lbnRzKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwcm94eUN1cnNvclJlcXVlc3RNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHByb21pc2lmeUN1cnNvclJlcXVlc3RDYWxsKHRoaXNbdGFyZ2V0UHJvcF0sIHByb3AsIGFyZ3VtZW50cyk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gSW5kZXgoaW5kZXgpIHtcbiAgICB0aGlzLl9pbmRleCA9IGluZGV4O1xuICB9XG5cbiAgcHJveHlQcm9wZXJ0aWVzKEluZGV4LCAnX2luZGV4JywgW1xuICAgICduYW1lJyxcbiAgICAna2V5UGF0aCcsXG4gICAgJ211bHRpRW50cnknLFxuICAgICd1bmlxdWUnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoSW5kZXgsICdfaW5kZXgnLCBJREJJbmRleCwgW1xuICAgICdnZXQnLFxuICAgICdnZXRLZXknLFxuICAgICdnZXRBbGwnLFxuICAgICdnZXRBbGxLZXlzJyxcbiAgICAnY291bnQnXG4gIF0pO1xuXG4gIHByb3h5Q3Vyc29yUmVxdWVzdE1ldGhvZHMoSW5kZXgsICdfaW5kZXgnLCBJREJJbmRleCwgW1xuICAgICdvcGVuQ3Vyc29yJyxcbiAgICAnb3BlbktleUN1cnNvcidcbiAgXSk7XG5cbiAgZnVuY3Rpb24gQ3Vyc29yKGN1cnNvciwgcmVxdWVzdCkge1xuICAgIHRoaXMuX2N1cnNvciA9IGN1cnNvcjtcbiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVxdWVzdDtcbiAgfVxuXG4gIHByb3h5UHJvcGVydGllcyhDdXJzb3IsICdfY3Vyc29yJywgW1xuICAgICdkaXJlY3Rpb24nLFxuICAgICdrZXknLFxuICAgICdwcmltYXJ5S2V5JyxcbiAgICAndmFsdWUnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoQ3Vyc29yLCAnX2N1cnNvcicsIElEQkN1cnNvciwgW1xuICAgICd1cGRhdGUnLFxuICAgICdkZWxldGUnXG4gIF0pO1xuXG4gIC8vIHByb3h5ICduZXh0JyBtZXRob2RzXG4gIFsnYWR2YW5jZScsICdjb250aW51ZScsICdjb250aW51ZVByaW1hcnlLZXknXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHtcbiAgICBpZiAoIShtZXRob2ROYW1lIGluIElEQkN1cnNvci5wcm90b3R5cGUpKSByZXR1cm47XG4gICAgQ3Vyc29yLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGN1cnNvciA9IHRoaXM7XG4gICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICBjdXJzb3IuX2N1cnNvclttZXRob2ROYW1lXS5hcHBseShjdXJzb3IuX2N1cnNvciwgYXJncyk7XG4gICAgICAgIHJldHVybiBwcm9taXNpZnlSZXF1ZXN0KGN1cnNvci5fcmVxdWVzdCkudGhlbihmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICAgICAgICByZXR1cm4gbmV3IEN1cnNvcih2YWx1ZSwgY3Vyc29yLl9yZXF1ZXN0KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9KTtcblxuICBmdW5jdGlvbiBPYmplY3RTdG9yZShzdG9yZSkge1xuICAgIHRoaXMuX3N0b3JlID0gc3RvcmU7XG4gIH1cblxuICBPYmplY3RTdG9yZS5wcm90b3R5cGUuY3JlYXRlSW5kZXggPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IEluZGV4KHRoaXMuX3N0b3JlLmNyZWF0ZUluZGV4LmFwcGx5KHRoaXMuX3N0b3JlLCBhcmd1bWVudHMpKTtcbiAgfTtcblxuICBPYmplY3RTdG9yZS5wcm90b3R5cGUuaW5kZXggPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IEluZGV4KHRoaXMuX3N0b3JlLmluZGV4LmFwcGx5KHRoaXMuX3N0b3JlLCBhcmd1bWVudHMpKTtcbiAgfTtcblxuICBwcm94eVByb3BlcnRpZXMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBbXG4gICAgJ25hbWUnLFxuICAgICdrZXlQYXRoJyxcbiAgICAnaW5kZXhOYW1lcycsXG4gICAgJ2F1dG9JbmNyZW1lbnQnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBJREJPYmplY3RTdG9yZSwgW1xuICAgICdwdXQnLFxuICAgICdhZGQnLFxuICAgICdkZWxldGUnLFxuICAgICdjbGVhcicsXG4gICAgJ2dldCcsXG4gICAgJ2dldEFsbCcsXG4gICAgJ2dldEtleScsXG4gICAgJ2dldEFsbEtleXMnLFxuICAgICdjb3VudCdcbiAgXSk7XG5cbiAgcHJveHlDdXJzb3JSZXF1ZXN0TWV0aG9kcyhPYmplY3RTdG9yZSwgJ19zdG9yZScsIElEQk9iamVjdFN0b3JlLCBbXG4gICAgJ29wZW5DdXJzb3InLFxuICAgICdvcGVuS2V5Q3Vyc29yJ1xuICBdKTtcblxuICBwcm94eU1ldGhvZHMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBJREJPYmplY3RTdG9yZSwgW1xuICAgICdkZWxldGVJbmRleCdcbiAgXSk7XG5cbiAgZnVuY3Rpb24gVHJhbnNhY3Rpb24oaWRiVHJhbnNhY3Rpb24pIHtcbiAgICB0aGlzLl90eCA9IGlkYlRyYW5zYWN0aW9uO1xuICAgIHRoaXMuY29tcGxldGUgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGlkYlRyYW5zYWN0aW9uLm9uY29tcGxldGUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcbiAgICAgIGlkYlRyYW5zYWN0aW9uLm9uZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVqZWN0KGlkYlRyYW5zYWN0aW9uLmVycm9yKTtcbiAgICAgIH07XG4gICAgICBpZGJUcmFuc2FjdGlvbi5vbmFib3J0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJlamVjdChpZGJUcmFuc2FjdGlvbi5lcnJvcik7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgVHJhbnNhY3Rpb24ucHJvdG90eXBlLm9iamVjdFN0b3JlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTdG9yZSh0aGlzLl90eC5vYmplY3RTdG9yZS5hcHBseSh0aGlzLl90eCwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKFRyYW5zYWN0aW9uLCAnX3R4JywgW1xuICAgICdvYmplY3RTdG9yZU5hbWVzJyxcbiAgICAnbW9kZSdcbiAgXSk7XG5cbiAgcHJveHlNZXRob2RzKFRyYW5zYWN0aW9uLCAnX3R4JywgSURCVHJhbnNhY3Rpb24sIFtcbiAgICAnYWJvcnQnXG4gIF0pO1xuXG4gIGZ1bmN0aW9uIFVwZ3JhZGVEQihkYiwgb2xkVmVyc2lvbiwgdHJhbnNhY3Rpb24pIHtcbiAgICB0aGlzLl9kYiA9IGRiO1xuICAgIHRoaXMub2xkVmVyc2lvbiA9IG9sZFZlcnNpb247XG4gICAgdGhpcy50cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbih0cmFuc2FjdGlvbik7XG4gIH1cblxuICBVcGdyYWRlREIucHJvdG90eXBlLmNyZWF0ZU9iamVjdFN0b3JlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTdG9yZSh0aGlzLl9kYi5jcmVhdGVPYmplY3RTdG9yZS5hcHBseSh0aGlzLl9kYiwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKFVwZ3JhZGVEQiwgJ19kYicsIFtcbiAgICAnbmFtZScsXG4gICAgJ3ZlcnNpb24nLFxuICAgICdvYmplY3RTdG9yZU5hbWVzJ1xuICBdKTtcblxuICBwcm94eU1ldGhvZHMoVXBncmFkZURCLCAnX2RiJywgSURCRGF0YWJhc2UsIFtcbiAgICAnZGVsZXRlT2JqZWN0U3RvcmUnLFxuICAgICdjbG9zZSdcbiAgXSk7XG5cbiAgZnVuY3Rpb24gREIoZGIpIHtcbiAgICB0aGlzLl9kYiA9IGRiO1xuICB9XG5cbiAgREIucHJvdG90eXBlLnRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbih0aGlzLl9kYi50cmFuc2FjdGlvbi5hcHBseSh0aGlzLl9kYiwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKERCLCAnX2RiJywgW1xuICAgICduYW1lJyxcbiAgICAndmVyc2lvbicsXG4gICAgJ29iamVjdFN0b3JlTmFtZXMnXG4gIF0pO1xuXG4gIHByb3h5TWV0aG9kcyhEQiwgJ19kYicsIElEQkRhdGFiYXNlLCBbXG4gICAgJ2Nsb3NlJ1xuICBdKTtcblxuICAvLyBBZGQgY3Vyc29yIGl0ZXJhdG9yc1xuICAvLyBUT0RPOiByZW1vdmUgdGhpcyBvbmNlIGJyb3dzZXJzIGRvIHRoZSByaWdodCB0aGluZyB3aXRoIHByb21pc2VzXG4gIFsnb3BlbkN1cnNvcicsICdvcGVuS2V5Q3Vyc29yJ10uZm9yRWFjaChmdW5jdGlvbihmdW5jTmFtZSkge1xuICAgIFtPYmplY3RTdG9yZSwgSW5kZXhdLmZvckVhY2goZnVuY3Rpb24oQ29uc3RydWN0b3IpIHtcbiAgICAgIC8vIERvbid0IGNyZWF0ZSBpdGVyYXRlS2V5Q3Vyc29yIGlmIG9wZW5LZXlDdXJzb3IgZG9lc24ndCBleGlzdC5cbiAgICAgIGlmICghKGZ1bmNOYW1lIGluIENvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHJldHVybjtcblxuICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlW2Z1bmNOYW1lLnJlcGxhY2UoJ29wZW4nLCAnaXRlcmF0ZScpXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKTtcbiAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdO1xuICAgICAgICB2YXIgbmF0aXZlT2JqZWN0ID0gdGhpcy5fc3RvcmUgfHwgdGhpcy5faW5kZXg7XG4gICAgICAgIHZhciByZXF1ZXN0ID0gbmF0aXZlT2JqZWN0W2Z1bmNOYW1lXS5hcHBseShuYXRpdmVPYmplY3QsIGFyZ3Muc2xpY2UoMCwgLTEpKTtcbiAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICBjYWxsYmFjayhyZXF1ZXN0LnJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICB9O1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBwb2x5ZmlsbCBnZXRBbGxcbiAgW0luZGV4LCBPYmplY3RTdG9yZV0uZm9yRWFjaChmdW5jdGlvbihDb25zdHJ1Y3Rvcikge1xuICAgIGlmIChDb25zdHJ1Y3Rvci5wcm90b3R5cGUuZ2V0QWxsKSByZXR1cm47XG4gICAgQ29uc3RydWN0b3IucHJvdG90eXBlLmdldEFsbCA9IGZ1bmN0aW9uKHF1ZXJ5LCBjb3VudCkge1xuICAgICAgdmFyIGluc3RhbmNlID0gdGhpcztcbiAgICAgIHZhciBpdGVtcyA9IFtdO1xuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xuICAgICAgICBpbnN0YW5jZS5pdGVyYXRlQ3Vyc29yKHF1ZXJ5LCBmdW5jdGlvbihjdXJzb3IpIHtcbiAgICAgICAgICBpZiAoIWN1cnNvcikge1xuICAgICAgICAgICAgcmVzb2x2ZShpdGVtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGl0ZW1zLnB1c2goY3Vyc29yLnZhbHVlKTtcblxuICAgICAgICAgIGlmIChjb3VudCAhPT0gdW5kZWZpbmVkICYmIGl0ZW1zLmxlbmd0aCA9PSBjb3VudCkge1xuICAgICAgICAgICAgcmVzb2x2ZShpdGVtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGN1cnNvci5jb250aW51ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH0pO1xuXG4gIHZhciBleHAgPSB7XG4gICAgb3BlbjogZnVuY3Rpb24obmFtZSwgdmVyc2lvbiwgdXBncmFkZUNhbGxiYWNrKSB7XG4gICAgICB2YXIgcCA9IHByb21pc2lmeVJlcXVlc3RDYWxsKGluZGV4ZWREQiwgJ29wZW4nLCBbbmFtZSwgdmVyc2lvbl0pO1xuICAgICAgdmFyIHJlcXVlc3QgPSBwLnJlcXVlc3Q7XG5cbiAgICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgICBpZiAodXBncmFkZUNhbGxiYWNrKSB7XG4gICAgICAgICAgICB1cGdyYWRlQ2FsbGJhY2sobmV3IFVwZ3JhZGVEQihyZXF1ZXN0LnJlc3VsdCwgZXZlbnQub2xkVmVyc2lvbiwgcmVxdWVzdC50cmFuc2FjdGlvbikpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHAudGhlbihmdW5jdGlvbihkYikge1xuICAgICAgICByZXR1cm4gbmV3IERCKGRiKTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgZGVsZXRlOiBmdW5jdGlvbihuYW1lKSB7XG4gICAgICByZXR1cm4gcHJvbWlzaWZ5UmVxdWVzdENhbGwoaW5kZXhlZERCLCAnZGVsZXRlRGF0YWJhc2UnLCBbbmFtZV0pO1xuICAgIH1cbiAgfTtcblxuICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBtb2R1bGUuZXhwb3J0cyA9IGV4cDtcbiAgICBtb2R1bGUuZXhwb3J0cy5kZWZhdWx0ID0gbW9kdWxlLmV4cG9ydHM7XG4gIH1cbiAgZWxzZSB7XG4gICAgc2VsZi5pZGIgPSBleHA7XG4gIH1cbn0oKSk7XG4iLCIvKipcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXN0YXVyYW50c2A7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEYXRhYmFzZSBVUkwuXHJcbiAgICogRm9yIHN0b3JpbmcgcmV2aWV3c1xyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXQgUkVWSUVXU19VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXZpZXdzL2A7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIHJlc3RhdXJhbnRzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrKSB7XHJcbiAgICBjb25zdCBkYlByb21pc2UgPSBpZGIub3BlbigncmVzdGF1bnRzREInLCAxLCBmdW5jdGlvbih1cGdyYWRlRGIpIHtcclxuICAgICAgdXBncmFkZURiLmNyZWF0ZU9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycgLCB7XHJcbiAgICAgICAga2V5UGF0aDogJ2lkJ1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRiUHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIC8vIGNyZWF0ZSB0aGUgdHJhbnNhY3Rpb24gaW4gcmVhZC93cml0ZSBvcGVyYXRpb24gYW5kIG9wZW4gdGhlIHN0b3JlIGZvciByZXN0YXVyYW50c1xyXG4gICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnKTtcclxuICAgICAgdmFyIHJlc3RhdXJhbnRTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xyXG4gICAgICByZXR1cm4gcmVzdGF1cmFudFN0b3JlLmdldEFsbCgpO1xyXG4gICAgfSkudGhlbihmdW5jdGlvbiAocmVzdGF1cmFudHMpe1xyXG4gICAgICBpZiAocmVzdGF1cmFudHMubGVuZ3RoID09IDAgKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJubyBoYXkgZGF0b3NcIik7XHJcbiAgICAgICAgLy8gTm8gZGF0YSBvbiBCQkRELiBGZXRjaGluZyBmcm9tIG91ciBzZXJ2ZXJcclxuICAgICAgICBmZXRjaChEQkhlbHBlci5EQVRBQkFTRV9VUkwpXHJcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5qc29uKCkpXHJcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN0YXVyYW50cykge1xyXG4gICAgICAgICAgICAvLyBhZGRpbmcgdG8gZGF0YWJhc2VcclxuICAgICAgICAgICAgZGJQcm9taXNlLnRoZW4oIGRiID0+e1xyXG4gICAgICAgICAgICAgIHZhciB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycsJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgICAgICB2YXIgcmVzdGF1cmFudFN0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJyk7XHJcblxyXG4gICAgICAgICAgICByZXN0YXVyYW50cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc3RhdXJhbnRTdG9yZS5wdXQoZWxlbWVudCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLHJlc3RhdXJhbnRzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yLG51bGwpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBSZXN0dWFyYW50cyBpbiBEQlxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwscmVzdGF1cmFudHMpO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYSByZXN0YXVyYW50IGJ5IGl0cyBJRC5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgY2FsbGJhY2spIHtcclxuICAgIC8vIGZldGNoIGFsbCByZXN0YXVyYW50cyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmVzdGF1cmFudCA9IHJlc3RhdXJhbnRzLmZpbmQociA9PiByLmlkID09IGlkKTtcclxuICAgICAgICBpZiAocmVzdGF1cmFudCkgeyAvLyBHb3QgdGhlIHJlc3RhdXJhbnRcclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIFJlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QgaW4gdGhlIGRhdGFiYXNlXHJcbiAgICAgICAgICBjYWxsYmFjaygnUmVzdGF1cmFudCBkb2VzIG5vdCBleGlzdCcsIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHM7XHJcbiAgICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobmVpZ2hib3Job29kICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBuZWlnaGJvcmhvb2RcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBuZWlnaGJvcmhvb2RzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaE5laWdoYm9yaG9vZHMoY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBHZXQgYWxsIG5laWdoYm9yaG9vZHMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBuZWlnaGJvcmhvb2RzID0gcmVzdGF1cmFudHMubWFwKCh2LCBpKSA9PiByZXN0YXVyYW50c1tpXS5uZWlnaGJvcmhvb2QpXHJcbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBuZWlnaGJvcmhvb2RzXHJcbiAgICAgICAgY29uc3QgdW5pcXVlTmVpZ2hib3Job29kcyA9IG5laWdoYm9yaG9vZHMuZmlsdGVyKCh2LCBpKSA9PiBuZWlnaGJvcmhvb2RzLmluZGV4T2YodikgPT0gaSlcclxuICAgICAgICBjYWxsYmFjayhudWxsLCB1bmlxdWVOZWlnaGJvcmhvb2RzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgY3Vpc2luZXMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoQ3Vpc2luZXMoY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBHZXQgYWxsIGN1aXNpbmVzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSlcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIGN1aXNpbmVzXHJcbiAgICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSlcclxuICAgICAgICBjYWxsYmFjayhudWxsLCB1bmlxdWVDdWlzaW5lcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgdXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIHNyY3NldCBmb3IgcmVzcG9uc2l2ZXMgaW1hZ2VzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZXNTcmNzZXRGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIC8vIGFkZGluZyBhdHJpYnV0dGVzIGZvciByZXNwb25zaXZlIGltYWdlc1xyXG4gICAgY29uc3QgZXh0ZW5zaW9uPVwianBnXCI7Ly9yZXN0YXVyYW50LnBob3RvZ3JhcGgubWF0Y2goL1xcLihbXi5cXFxcXFwvXSspJC8pLnBvcCgpO1xyXG4gICAgbGV0IGZpbGVuYW1lID0gcmVzdGF1cmFudC5waG90b2dyYXBoOy8vcmVzdGF1cmFudC5waG90b2dyYXBoLnJlcGxhY2UoL1xcLihbXi5cXFxcXFwvXSspJC8sJycpXHJcbiAgICBpZiAoIWZpbGVuYW1lKSBmaWxlbmFtZT1cIjEwXCI7XHJcbiAgICByZXR1cm4gKGAvaW1nLyR7ZmlsZW5hbWV9LXNtYWxsLiR7ZXh0ZW5zaW9ufSAyNTB3LFxyXG4gICAgICAgICAgICAvaW1nLyR7ZmlsZW5hbWV9LW1lZGl1bS4ke2V4dGVuc2lvbn0gNDYwdyxcclxuICAgICAgICAgICAgL2ltZy8ke2ZpbGVuYW1lfS1sYXJnZS4ke2V4dGVuc2lvbn0gODAwd2ApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBzcmNzZXQgZm9yIHJlc3BvbnNpdmVzIGltYWdlcy5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VTaXplc0ZvclJlc3RhdXJhbnQoaW5uZXIpIHtcclxuICAgIC8vIGFkZGluZyBhdHJpYnV0dGVzIGZvciByZXNwb25zaXZlIGltYWdlc1xyXG4gICAgaWYgKGlubmVyKSByZXR1cm4gYChtYXgtd2lkdGg6IDYxOHB4KSBjYWxjKDEwMHZ3IC0gODBweCksIGNhbGMoNTB2dyAtIDgwcHgpYDtcclxuICAgIHJldHVybiBgKG1heC13aWR0aDogNjE4cHgpIGNhbGMoMTAwdncgLSA5MHB4KSwgY2FsYyg1MHZ3IC0gOTBweClgO1xyXG4gIH1cclxuXHJcbiAgIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2Ugc3Jjc2V0LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgLy8gYWRkaW5nIGF0cmlidXR0ZXMgZm9yIHJlc3BvbnNpdmUgaW1hZ2VzXHJcbiAgICBjb25zdCBleHRlbnNpb249XCJqcGdcIjsvL3Jlc3RhdXJhbnQucGhvdG9ncmFwaC5tYXRjaCgvXFwuKFteLlxcXFxcXC9dKykkLykucG9wKCk7XHJcbiAgICBsZXQgZmlsZW5hbWUgPSByZXN0YXVyYW50LnBob3RvZ3JhcGg7Ly9yZXN0YXVyYW50LnBob3RvZ3JhcGgucmVwbGFjZSgvXFwuKFteLlxcXFxcXC9dKykkLywnJylcclxuICAgIGlmICghZmlsZW5hbWUpIGZpbGVuYW1lPVwiMTBcIjtcclxuICAgIHJldHVybiAoYC9pbWcvJHtmaWxlbmFtZX0tc21hbGwuJHtleHRlbnNpb259YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNYXAgbWFya2VyIGZvciBhIHJlc3RhdXJhbnQuXHJcbiAgICovXHJcbiAgc3RhdGljIG1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbWFwKSB7XHJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICB0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICB1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXHJcbiAgICAgIG1hcDogbWFwLFxyXG4gICAgICBhbmltYXRpb246IGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5EUk9QfVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogU3RvcmVzIGEgcmV2aWV3IGluIHRoZSBzZWxlY3RlZCBkYWJhdGFiYXNlLlxyXG4gICAqIFJldHVybiBhIFByb21pc2Ugd2l0aCB0aGUgc3RhdGUgb2YgdGhlIGluc2VydFxyXG4gICAqL1xyXG4gIHN0YXRpYyBzdG9yZVJldmlld3NEQihyZXZpZXdzLCBkYXRhYmFzZSkge1xyXG4gICAgY29uc3QgZGJQcm9taXNlID0gaWRiLm9wZW4oZGF0YWJhc2UsIDEsIGZ1bmN0aW9uKHVwZ3JhZGVEYikge1xyXG4gICAgICB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jldmlld3MnICwge1xyXG4gICAgICAgIGtleVBhdGg6ICduYW1lJ1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBkYlByb21pc2UudGhlbihmdW5jdGlvbihkYikge1xyXG4gICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbigncmV2aWV3cycsJ3JlYWR3cml0ZScpO1xyXG4gICAgICB2YXIgcmV2aWV3c1N0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jldmlld3MnKTtcclxuICAgICAgcmV2aWV3cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIHJldmlld3NTdG9yZS5wdXQoZWxlbWVudCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBkZWxldGUgYSByZXZpZXcgaW4gdGhlIHNlbGVjdGVkIGRhYmF0YWJhc2UuXHJcbiAgICogUmV0dXJuIGEgUHJvbWlzZSB3aXRoIHRoZSBzdGF0ZSBvZiB0aGUgZGVsZXRlXHJcbiAgICovXHJcbiAgc3RhdGljIHJlbW92ZVJldmlld0Zyb21EQihyZXZpZXcsIGRhdGFiYXNlKSB7XHJcbiAgICBjb25zdCBkYlByb21pc2UgPSBpZGIub3BlbihkYXRhYmFzZSwgMSwgZnVuY3Rpb24odXBncmFkZURiKSB7XHJcbiAgICAgIHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZSgncmV2aWV3cycgLCB7XHJcbiAgICAgICAga2V5UGF0aDogJ25hbWUnXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGRiUHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGRhdGFiYXNlKTtcclxuICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnLCdyZWFkd3JpdGUnKTtcclxuICAgICAgdmFyIHJldmlld3NTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XHJcbiAgICAgIHJldmlld3NTdG9yZS5kZWxldGUocmV2aWV3Lm5hbWUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRyaWV2ZXMgYSBsaXN0IG9mIHJldmlld3MgaW4gdGhlIHNlbGVjdGVkIGRhYmF0YWJhc2UuXHJcbiAgICogUmV0dXJuIGEgUHJvbWlzZSB3aXRoIHRoZSByZXZpZXdzXHJcbiAgICovXHJcbiAgc3RhdGljIGdldEFsbFJldmlld3NEQihkYXRhYmFzZSkge1xyXG4gICAgY29uc3QgZGJQcm9taXNlID0gaWRiLm9wZW4oZGF0YWJhc2UsIDEsIGZ1bmN0aW9uKHVwZ3JhZGVEYikge1xyXG4gICAgICB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jldmlld3MnICwge1xyXG4gICAgICAgIGtleVBhdGg6ICduYW1lJ1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBkYlByb21pc2UudGhlbihmdW5jdGlvbihkYikge1xyXG4gICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbigncmV2aWV3cycpO1xyXG4gICAgICB2YXIgcmV2aWV3c1N0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jldmlld3MnKTtcclxuICAgICAgcmV0dXJuIHJldmlld3NTdG9yZS5nZXRBbGwoKTtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kIHBvc3QgcmVxdWVzdCBmb3IgYWRkaW5nIHJldmlldyB0byBhIHNlcnZlclxyXG4gICAqL1xyXG4gIHN0YXRpYyBzZW5kUG9zdFJlcXVlc3QocmV2aWV3KSB7XHJcbiAgICByZXR1cm4gZmV0Y2goREJIZWxwZXIuUkVWSUVXU19VUkwsIHtcclxuICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJldmlldylcclxuICAgIH0pXHJcbiAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgICAgLy8gRXJyb3IgZmV0Y2hpbmcgcG9zdCByZXF1ZXN0LCBubyBuZXR3b3JrLCBzY2hlZHVsZSB0aGUgc2VuZFxyXG4gICAgICAvLyBzdG9yaW5nIGl0IGluIGlkYlxyXG4gICAgICBjb25zdCByZXZpZXdzID0gW107XHJcbiAgICAgIHJldmlld3MucHVzaChyZXZpZXcpO1xyXG4gICAgICBjb25zb2xlLmxvZyhcImRhdGFiYXNlXCIpO1xyXG4gICAgICByZXR1cm4gREJIZWxwZXIuc3RvcmVSZXZpZXdzREIocmV2aWV3cywgJ3BlbmRpbmdQb3N0c0RCJyk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRvZ2dsZSBmYXZvdXJpdGUgdG8gdHJ1ZSBpbiBhIHJlc3RhdXJhbnRcclxuICAgKi9cclxuICBzdGF0aWMgYWRkVG9GYXZvcml0ZXMoaWQpIHtcclxuICAgIGNvbnN0IHVybCA9IGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vJHtpZH0vP2lzX2Zhdm9yaXRlPXRydWVgO1xyXG4gICAgZmV0Y2godXJsLCB7IG1ldGhvZDogJ1BVVCcgfSkudGhlbigoKT0+e1xyXG4gICAgICBjb25zb2xlLmxvZygndXBkYXRlZCcpO1xyXG4gICAgICB0aGlzLnVwZGF0ZVJlc3RhdXJhbnQoaWQsXCJ0cnVlXCIpO1xyXG4gICAgfSkuY2F0Y2goZXJyb3I9PmNvbnNvbGUubG9nKGVycm9yKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUb2dnbGUgZmF2b3VyaXRlIHRvIGZhbHNlIGluIGEgcmVzdGF1cmFudFxyXG4gICAqL1xyXG4gIHN0YXRpYyByZW1vdmVGcm9tRmF2b3JpdGVzKGlkKSB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7aWR9Lz9pc19mYXZvcml0ZT1mYWxzZWA7XHJcbiAgICBmZXRjaCh1cmwsIHsgbWV0aG9kOiAnUFVUJyB9KS50aGVuKCgpPT57XHJcbiAgICAgIGNvbnNvbGUubG9nKCd1cGRhdGVkJyk7XHJcbiAgICAgIHRoaXMudXBkYXRlUmVzdGF1cmFudChpZCxcImZhbHNlXCIpO1xyXG4gICAgfSkuY2F0Y2goZXJyb3I9PmNvbnNvbGUubG9nKGVycm9yKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgICAqIFN0b3JlcyBhIHJldmlldyBpbiB0aGUgc2VsZWN0ZWQgZGFiYXRhYmFzZS5cclxuICAgICAqIFJldHVybiBhIFByb21pc2Ugd2l0aCB0aGUgc3RhdGUgb2YgdGhlIGluc2VydFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgdXBkYXRlUmVzdGF1cmFudChpZCx2YWx1ZSkge1xyXG4gICAgICBjb25zdCBkYlByb21pc2UgPSBpZGIub3BlbigncmVzdGF1bnRzREInLCAxLCBmdW5jdGlvbih1cGdyYWRlRGIpIHtcclxuICAgICAgICB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJyAsIHtcclxuICAgICAgICAgIGtleVBhdGg6ICdpZCdcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZnVuY3Rpb24oZGIpIHtcclxuICAgICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnLCdyZWFkd3JpdGUnKTtcclxuICAgICAgICB2YXIgcmVzdGF1cmFudFN0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJyk7XHJcbiAgICAgICAgcmVzdGF1cmFudFN0b3JlLmdldChpZCkudGhlbiggcmVzdGF1cmFudCA9PiB7XHJcbiAgICAgICAgICByZXN0YXVyYW50LmlzX2Zhdm9yaXRlPXZhbHVlO1xyXG4gICAgICAgICAgcmVzdGF1cmFudFN0b3JlLnB1dChyZXN0YXVyYW50KVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogRGVsZXRlIGEgcmV2aWV3IGZyb20gc2VydmVyIHRocm91Z2h0IGRlbGV0ZSByZXF1ZXN0XHJcbiAgICogaGFuZHkgZmV0Y2goXCJodHRwOi8vbG9jYWxob3N0OjEzMzcvcmV2aWV3cy81M1wiLCB7bWV0aG9kOiAnREVMRVRFJ30pLnRoZW4ocmVzcD0+Y29uc29sZS5sb2cocmVzcCkpLmNhdGNoKGVycj0+Y29uc29sZS5sb2coZXJyKSk7XHJcbiAgICovXHJcbiAgc3RhdGljIGRlbGV0ZVJldmlldyhyZXZpZXcpe1xyXG4gICAgaWYgKHJldmlldy5pZClcclxuICAgICAgcmV0dXJuIGZldGNoKChgJHtEQkhlbHBlci5SRVZJRVdTX1VSTH0ke3Jldmlldy5pZH1gLCB7bWV0aG9kOiAnREVMRVRFJ30pKTtcclxuICAgIHJldHVybiAvLyBUT0RPIGRlbGV0ZSBmcm9tIHBhZ2UgYW5kIElEQiBwZW5kaW5nUG9zdHNEQlxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXZpZXdzIGZvciBhIHJlc3R1YXJhbnQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmV2aWV3c0J5SWQoaWQsIGNhbGxiYWNrKSB7XHJcblxyXG4gICAgLy8gRmV0Y2hpbmcgcmV2aWV3cyBmcm9tIG5ldHdvcmtcclxuICAgIGZldGNoKGAke0RCSGVscGVyLlJFVklFV1NfVVJMfT9yZXN0YXVyYW50X2lkPSR7aWR9YClcclxuICAgICAgLnRoZW4ocmVzcG9uc2U9PnJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHJldmlld3MpIHtcclxuICAgICAgICAvL3N0b3JpbmcgaXQgaW4gaWRiIGRhdGFiYXNlXHJcbiAgICAgICAgREJIZWxwZXIuc3RvcmVSZXZpZXdzREIocmV2aWV3cywgJ3Jldmlld3MnKVxyXG4gICAgICAgIC50aGVuKGNhbGxiYWNrKG51bGwscmV2aWV3cykpXHJcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IGNhbGxiYWNrKGVycm9yLG51bGwpKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgIC8vIE9mZmxpbmUgbW9kZSBvciBuZXR3b3JrIGVycm9yXHJcbiAgICAgICAgLy9yZWNvdmVyIGZyb20gaWRiIGRhdGFiYXNlIGlmIHdlIGNvdWxkXHJcbiAgICAgICAgREJIZWxwZXIuZ2V0QWxsUmV2aWV3c0RCKCdyZXZpZXdzJylcclxuICAgICAgICAudGhlbiAoZnVuY3Rpb24gKHJldmlld3MpIHtcclxuICAgICAgICAgIC8vIE9yIHJldmlldyBkYXRhYmFzZSBpcyBlbXB0eSBvciByZXR1cm5zIGRhdGFcclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwscmV2aWV3cyk7XHJcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcclxuICAgICAgICAgIC8vIEVycm9yIHJldHJpZXZpbmcgZnJvbSBkYlxyXG4gICAgICAgICAgY2FsbGJhY2soZXJyb3IsbnVsbCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==
